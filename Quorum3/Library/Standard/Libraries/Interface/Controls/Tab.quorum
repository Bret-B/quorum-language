package Libraries.Interface.Controls

use Libraries.Interface.Layouts.Layout
use Libraries.Interface.Layouts.FlowLayout
use Libraries.Interface.Layouts.LayoutProperties
use Libraries.Interface.Item2D
use Libraries.Game.Graphics.Drawable
use Libraries.Game.Graphics.Label
use Libraries.Containers.Array
use Libraries.Game.Graphics.Color
use Libraries.Game.Graphics.ColorGroup
use Libraries.Game.Graphics.Gradient
use Libraries.Game.Graphics.Texture
use Libraries.Game.Graphics.TextureRegion
use Libraries.Game.Graphics.Font
use Libraries.Interface.Views.View2D
use Libraries.Interface.Views.LabelBoxView
use Libraries.Interface.Views.LabelBoxToggleView
use Libraries.Interface.Behaviors.Controls.TabCloseBehavior

class Tab is ToggleButton
    
    Item2D relatedItem = undefined
    Layout layout = undefined
    LayoutProperties defaultProperties = undefined
    LayoutProperties iconLayoutProperties = undefined
    LayoutProperties labelLayoutProperties = undefined
    LayoutProperties buttonLayoutProperties = undefined

    Icon icon
    Label label
    Button closeButton

    on create
        AllowToggleOff(false)

        FlowLayout flow
        layout = flow
        SetLayout(flow)

        iconLayoutProperties = icon:GetDefaultLayoutProperties()
        iconLayoutProperties:SetHorizontalLayoutMode(iconLayoutProperties:MAINTAIN_ASPECT_RATIO)
        iconLayoutProperties:SetVerticalLayoutMode(iconLayoutProperties:STANDARD)
        iconLayoutProperties:SetPercentageWidth(1.0)
        iconLayoutProperties:SetPercentageHeight(1.0)
        iconLayoutProperties:SetTopPadding(4)
        iconLayoutProperties:SetBottomPadding(4)
        iconLayoutProperties:SetLeftPadding(4)
        
        defaultProperties = GetDefaultLayoutProperties()
        defaultProperties:SetHorizontalLayoutMode(defaultProperties:FIT_CONTENTS)
        defaultProperties:SetVerticalLayoutMode(defaultProperties:FIT_FONT)
        Font font
        font:LoadFont("Arial")
        font:SetSize(16)
        defaultProperties:SetFont(font)
        defaultProperties:SetFontSize(16)

        labelLayoutProperties = label:GetDefaultLayoutProperties()
        buttonLayoutProperties = closeButton:GetDefaultLayoutProperties()

        SetAccessibilityCode(parent:Item:TAB)
        closeButton:SetName("Close")
        closeButton:SetFont(undefined)
        Icon closeIcon
        Color color
        closeIcon:LoadFilledRectangle(10, 10, color:Red())
        closeButton:SetIcon(closeIcon)

        TabCloseBehavior behavior
        behavior:SetTab(me)
        closeButton:SetBehavior(behavior)

        labelLayoutProperties:SetHorizontalLayoutMode(labelLayoutProperties:FIT_CONTENTS)
        labelLayoutProperties:SetLeftPadding(7)
        labelLayoutProperties:SetRightPadding(7)

        buttonLayoutProperties:SetHorizontalLayoutMode(buttonLayoutProperties:MAINTAIN_ASPECT_RATIO)
        buttonLayoutProperties:SetVerticalLayoutMode(buttonLayoutProperties:STANDARD)
        buttonLayoutProperties:SetPercentageWidth(1.0)
        buttonLayoutProperties:SetPercentageHeight(1.0)
        buttonLayoutProperties:SetTopPadding(4)
        buttonLayoutProperties:SetBottomPadding(4)
        buttonLayoutProperties:SetRightPadding(4)

        icon:Hide()

        Add(icon)
        Add(label)
        Add(closeButton)
    end

    action SetRelatedItem(Item2D item)
        relatedItem = item
    end

    action GetRelatedItem returns Item2D
        return relatedItem
    end

    action SetIcon(Icon newIcon)
        parent:Control:SetIcon(newIcon)
        if newIcon = undefined
            icon:Hide()
        else
            icon:Load(newIcon)
            number aspectRatio = icon:GetWidth() / cast(number, icon:GetHeight())
            iconLayoutProperties:SetPercentageWidth(aspectRatio)
            icon:Show()
        end
    end

    action SetName(text name)
        label:SetText(name)
        icon:SetName(name + " Icon")
        parent:Item2D:SetName(name)
        Resize()
    end

    action ReleasedMouse
        boolean state = GetToggleState()
        if state = false
            SetToggleState(true)
        end
        parent:Control:ReleasedMouse()
    end

    action DisplayName(boolean display)
        displayLabel = display
        if display
            label:Show()
        else
            label:Hide()
        end
    end

    action DisplayCloseButton(boolean display)
        displayClose = display
        if display
            closeButton:Show()
        else
            closeButton:Hide()
        end
    end

    action IsDisplayingCloseButton returns boolean
        return closeButton:IsShowing()
    end

    action OnToggleOn
        if GetButtonGroup() is TabBar
            TabBar bar = cast(TabBar, GetButtonGroup())
            TabPane pane = bar:GetTabPane()
            if pane not= undefined
                pane:UpdateSelection(me)
            end

            bar:FitTab(me)
        end
    end

    action OnToggleOff
        if GetButtonGroup() is TabBar
            TabBar bar = cast(TabBar, GetButtonGroup())
            TabPane pane = bar:GetTabPane()
            if pane not= undefined
                pane:UpdateSelection(undefined)
            end
        end
    end

    /*
    For internal use only.
    */
    action GetLabel returns Label
        return label
    end

    /*
    This action is used to load the graphical components of the Control. This is
    handled automatically by the Game engine as needed, and most users shouldn't
    need to use this action directly.
    */
    action LoadGraphics(LayoutProperties properties)
        parent:Control:LoadGraphics(properties)

        if properties = undefined
            return now
        end

        TextureRegion region = properties:GetIcon()
        if region = undefined
            if icon:IsShowing()
                icon:Hide()
            end
        else
            if icon:IsShowing() = false
                icon:Load(region)
                number aspectRatio = icon:GetWidth() / cast(number, icon:GetHeight())
                iconLayoutProperties:SetPercentageWidth(aspectRatio)
                icon:Show()
            end
            icon:SetColor(properties:GetIconColor())
        end

        Font font = properties:GetFont()
        if font not= undefined
            label:SetFont(font)
            label:SetSize(cast(integer, properties:GetFontSize() * properties:GetZoomFactor()))
        else
            label:Hide()
        end

        View2D view = properties:GetView2D()
        if view = undefined
            if GetView2D() = undefined
                LabelBoxToggleView content
                Color color
                ColorGroup background = properties:GetBackgroundColor()
                ColorGroup border = properties:GetBorderColor()
                number thickness = properties:GetBorderThickness()
                if background = undefined
                    Gradient backgroundGradient
                    Color lightGray = color:CustomColor(0.9, 0.9, 0.9, 1)
                    Color gray = color:LightGray()
                    backgroundGradient:Set(gray, gray, lightGray, lightGray)
                    background = backgroundGradient
                end
                if border = undefined
                    border = color:Black()
                end
                Gradient selectionGradient
                selectionGradient:Set(background:GetTopLeft(), background:GetTopRight(), color:White(), color:White())
                content:SetBorderThickness(cast(integer, thickness))
                content:Initialize(background, border, selectionGradient, border)
                view = content
            else
                view = GetView2D()
            end
        end

        SetView2D(view)
    end
end