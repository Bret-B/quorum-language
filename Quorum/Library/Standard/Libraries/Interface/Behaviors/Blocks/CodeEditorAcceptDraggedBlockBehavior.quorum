package Libraries.Interface.Behaviors.Blocks

use Libraries.Interface.Behaviors.Behavior
use Libraries.Interface.Events.BehaviorEvent
use Libraries.Interface.Events.DragAndDropEvent
use Libraries.Interface.Item
use Libraries.Interface.Controls.Blocks.CodeEditor
use Libraries.Containers.Array
use Libraries.Interface.Controls.Blocks.Block
use Libraries.Interface.Controls.Blocks.BlockPalette
use Libraries.Interface.Controls.Blocks.BlockPaletteItem

class CodeEditorAcceptDraggedBlockBehavior is Behavior
    
    // The behavior that triggers when dragging begins.
    // This behavior contains info we need, so we store a reference here.
    // The reference is set when the behaviors are made in DefaultInputSets.
    BlockDragBehavior sourceDragBehavior = undefined
    
    integer lastCandidateLine = -2
    
    action Run(BehaviorEvent event)
        DragAndDropEvent dropEvent = event:GetDragAndDropEvent()
        Item received = dropEvent:GetDestination()
        
        Item source = dropEvent:GetSource()

        if received is CodeEditor
            CodeEditor editor = cast(CodeEditor, received)
            number y = dropEvent:GetY() - editor:GetGlobalY()
            integer line = editor:GetNavigationIndexAtY(y)
            if line >= editor:GetLineCount()
                line = editor:GetLineCount() - 1
            end
            
Array<Block> sourceBlocks = sourceDragBehavior:GetSourceBlocks()
            
            if dropEvent:eventType = dropEvent:DRAGGING_CONTINUED
                if line not= lastCandidateLine
                    
                    if editor:CanAcceptPlaceholdersAtNavigationIndex(line) = false
                        if editor:HasPlaceholders()
                            editor:RemovePlaceholders()
                        else
                            // Do nothing, there's no placeholders there to adjust.
                        end
                    elseif editor:HasPlaceholders()
editor:MovePlaceholdersToNavigationIndex(line)
                    else
                        Array<Block> placeholders
                        integer i = 0
                        repeat while i < sourceBlocks:GetSize()
                            if sourceBlocks:Get(i):IsPlaceholder()
                                placeholders:Add(sourceBlocks:Get(i))
                            else
placeholders:Add(sourceBlocks:Get(i):CopyToPlaceholder())
                                
                                
                            end
                            i = i + 1
                        end
                        editor:InsertPlaceholdersAtNavigationIndex(line, placeholders)
                    end
                    
                    lastCandidateLine = line
                end
            elseif dropEvent:eventType = dropEvent:DRAGGED_ONTO_DESTINATION
                lastCandidateLine = line
            elseif dropEvent:eventType = dropEvent:DROPPED
                if sourceBlocks:IsEmpty() = false
                    Block firstBlock = sourceBlocks:GetFromFront()
                    Block lastBlock = sourceBlocks:GetFromEnd()
                    text toInsert = ""

                        toInsert = firstBlock:GetEditor():GetCode():GetText(firstBlock:GetStartIndex(), lastBlock:GetEndIndex())+toInsert:GetLineFeed()
                    lastCandidateLine = -2
                    
                    if editor:HasPlaceholders()
                        editor:ConvertPlaceholdersToBlocks(toInsert)
                    end
                    sourceBlocks = undefined
                end
            end
        end
    end
    
    action SetSourceDragBehavior(BlockDragBehavior behavior)
        sourceDragBehavior = behavior
    end
    
    action GetSourceDragBehavior returns BlockDragBehavior
        return sourceDragBehavior
    end
    
end