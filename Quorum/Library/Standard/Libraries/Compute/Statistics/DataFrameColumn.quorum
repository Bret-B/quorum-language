package Libraries.Compute.Statistics
use Libraries.Compute.Statistics.DataFrameColumnCalculation
use Libraries.Compute.Vector
use Libraries.Compute.Statistics.Columns.NumberColumn
use Libraries.Compute.Statistics.Columns.IntegerColumn
use Libraries.Compute.Statistics.Columns.BooleanColumn
use Libraries.Compute.Statistics.Columns.TextColumn
use Libraries.Containers.Array

/*
    This class represents a column on the system. Columns do not have a type themselves,
    but all subclasses can be made to have any arbitrary type, even custom ones. Columns
    by default can accept calculations, which send elements to the calculation of the 
    appropriate type and conduct operations. DataFrame objects use the appropriate
    subclass of column automatically when reading in data frames from disk, based
    upon the first item in the spreadsheet.

    Note that in most cases, a user will not interact directly with this class. It is a 
    parent class that encapsulates some common functionality, but typically one would 
    pass a calculation or other operation to this class. The raw data of a column can 
    also be manipulated directly, but type information must be checked through the appropriate
    actions (e.g., IsBooleanColumn). This is to balance the need to sometimes iterate through
    a column with the opposite need to manipulate its data directly. 

    Attribute: Author Andreas Stefik

    Attribute: Example

    use Libraries.Compute.Statistics.DataFrame
    use Libraries.Compute.Statistics.DataFrameColumn

    //Load a comma separated file
    DataFrame frame
    frame:Load("Data.csv") 
    DataFrameColumn col = frame:GetColumn(0)
    output col:ToText()
*/
class DataFrameColumn 
    /* This is the name of the column. */
    text header = ""
    integer undefinedSize = 0
    
    /*
        This gets the header for this column.
    */
    action GetHeader returns text
        return header
    end

    /*
        This sets the header for this column.
    */
    action SetHeader(text header)
        me:header = header
    end

    /*
        Columns may optionally add data from a text representation of that data. 
        This can be in any arbitrary format determined by the column implementor. The 
        Add action does the auto-conversion, while the set values are only accepted
        if that data type is allowed. The broad purpose is to allow this action to read in
        from an arbitrary text source and add it to the column.

        Attribute: Parameter value The value to be converted to the proper type for this kind of column.
    */
    action Add(text value)
    end

    /*
        This action sends an individual data point to a calculation, typed
        appropriately by its subclass.

        Attribute: Parameter index Which part of the column to send the calculation
        Attribute: Parameter calculation the calculation to run on this part of the column
    */
    action SendValueTo(integer index, DataFrameColumnCalculation calculation)
    end

    /*
        This action detects whether a particular index is an undefined value in the column.

        Attribute: Parameter row The row of the column to check
        Attribute: Returns true if the row is undefined
    */
    blueprint action IsUndefined(integer row) returns boolean


    /*
        This action detects whether this column ultimately stores numbers inside of it. This
        type of information is implementation dependent, as arbitrary columns can store
        these numbers however they see fit.
        
        Attribute: Returns true if this column stores numbers
    */
    action IsNumberColumn returns boolean
        return false
    end

    /*
        This action detects whether this column ultimately stores booleans inside of it. This
        type of information is implementation dependent, as arbitrary columns can store
        these values however they see fit.
        
        Attribute: Returns true if this column stores booleans
    */
    action IsBooleanColumn returns boolean
        return false
    end

    /*
        This action detects whether this column ultimately stores text inside of it. This
        type of information is implementation dependent, as arbitrary columns can store
        these values however they see fit.
        
        Attribute: Returns true if this column stores text
    */
    action IsTextColumn returns boolean
        return false
    end

    /*
        This action detects whether this column ultimately stores integers inside of it. This
        type of information is implementation dependent, as arbitrary columns can store
        these values however they see fit.
        
        Attribute: Returns true if this column stores integers
    */
    action IsIntegerColumn returns boolean
        return false
    end

    /*
        Regardless of the type of the column, this action attempts
        to convert the item at the index to a number. 

        Attrribute: Parameter index the item to be converted
    */
    action GetAsNumber(integer index) returns number
        alert("Cannot convert value at position " + index + " to number.")
    end

    /*
        Regardless of the type of the column, this action attempts
        to convert the item at the index to text. 

        Attrribute: Parameter index the item to be converted
    */
    action GetAsText(integer index) returns text
        alert("Cannot convert value at position " + index + " to text.")
    end

    /*
        Regardless of the type of the column, this action attempts
        to convert the item at the index to a boolean. 

        Attrribute: Parameter index the item to be converted
    */
    action GetAsBoolean(integer index) returns boolean
        alert("Cannot convert value at position " + index + " to a boolean.")
    end

    /*
        Regardless of the type of the column, this action attempts
        to convert the item at the index to an integer. 

        Attrribute: Parameter index the item to be converted
    */
    action GetAsInteger(integer index) returns integer
        alert("Cannot convert value at position " + index + " to a boolean.")
    end

    /*
        This action sets the index to a number if and only if this is a number
        column.

        Attrribute: Parameter index the item to be converted
        Attribute: Parameter value the value to be placed in the column
    */
    action SetAsNumber(integer index, number value)
        alert("Cannot convert value at position " + index + " to number.")
    end

    /*
        This action sets the index to text if and only if this is a text
        column.

        Attrribute: Parameter index the item to be converted
        Attribute: Parameter value the value to be placed in the column
    */
    action SetAsText(integer index, text value)
        alert("Cannot convert value at position " + index + " to text.")
    end

    /*
        This action sets the index to a boolean if and only if this is a boolean
        column.

        Attrribute: Parameter index the item to be converted
        Attribute: Parameter value the value to be placed in the column
    */
    action SetAsBoolean(integer index, boolean value)
        alert("Cannot convert value at position " + index + " to boolean.")
    end

    /*
        This action sets the index to an integer if and only if this is an integer
        column.

        Attrribute: Parameter index the item to be converted
        Attribute: Parameter value the value to be placed in the column
    */
    action SetAsInteger(integer index, integer value)
        alert("Cannot convert value at position " + index + " to integer.")
    end

    /*
        Regardless of the type of this column, the system will attempt
        to convert it to a NumberColumn. This may cause an error to be thrown
        if the types are not compatible.

        Attrribute: Returns the newly converted column
    */
    action ConvertToNumberColumn returns NumberColumn
        NumberColumn column
        ConvertColumn(column)
        return column
    end

    /*
        Regardless of the type of this column, the system will attempt
        to convert it to an IntegerColumn. This may cause an error to be thrown
        if the types are not compatible.

        Attrribute: Returns the newly converted column
    */
    action ConvertToIntegerColumn returns IntegerColumn
        IntegerColumn column
        ConvertColumn(column)
        return column
    end

    /*
        Regardless of the type of this column, the system will attempt
        to convert it to a BooleanColumn. This may cause an error to be thrown
        if the types are not compatible.

        Attrribute: Returns the newly converted column
    */
    action ConvertToBooleanColumn returns BooleanColumn
        BooleanColumn column
        ConvertColumn(column)
        return column
    end

    /*
        Regardless of the type of this column, the system will attempt
        to convert it to a TextColumn. This may cause an error to be thrown
        if the types are not compatible.

        Attrribute: Returns the newly converted column
    */
    action ConvertToTextColumn returns TextColumn
        TextColumn column
        ConvertColumn(column)
        return column
    end

    private action ConvertColumn(DataFrameColumn column)
        column:SetHeader(GetHeader())

        integer i = 0
        integer size = GetSize()
        repeat while i < size
            text value = GetAsText(i)
            if value = undefined
                column:Add(undefined)
            else
                column:Add(value)
            end
            i = i + 1
        end
    end

    /*
        Some column types can be converted to a raw vector of numbers. All other
        column types throw an error if they cannot convert. This vector conversion
        stores numbers more tightly in primitive form, so no undefined values are allowed,
        but the system can process on the vector more quickly and efficiently.

        Attribute: Returns the vector
    */
    action ConvertToVector returns Vector
        alert("Cannot convert to Vector for this type of Column.")
    end

    /* 

        This action returns whether or not this column type can be converted to a Vector of numbers. 

        Attribute: Returns true if this column type can be converted and false if it would throw an error on conversion.

    */
    action CanConvertToVector returns boolean
        return false
    end

    /*
        This action swaps two values in the column. 

        Attribute: Parameter left the first index to swap
        Attribute: Parameter right the second index to swap
    */
    blueprint action Swap(integer left, integer right)

    /*
        This action moves the value in row left to the value in row right. 

        Attribute: Parameter left the first index to swap
        Attribute: Parameter right the second index to swap
    */
    blueprint action Move(integer left, integer right)

    /*
        This action conducts a calculation on this column. The calculation begins 
        by issuing a Start action. Then if it is an iterable action, sends each
        data point to the class for processing. If not, it is asked to conduct
        the entire operation at once on the full data set. Finally, it issues
        an end action. 

        Attribute: Parameter the calculation to do on this column.
    */
    action Calculate(DataFrameColumnCalculation calculation)
        if calculation = undefined
            return now
        end

        calculation:Start(me)
        boolean iterable = calculation:IsIterable()
        if iterable
            i = 0
            repeat while i < GetSize()
                SendValueTo(i, calculation)
                i = i + 1
            end
        else
            calculation:Calculate(me)
        end
        calculation:End(me)
    end

    /* This action conducts a deep copy of the column. */
    blueprint action Copy returns DataFrameColumn

    /* This action conducts a deep copy of the column. The two parameters indicate whether to sort
        the column or whether to require that it be unique.

        Attribute: Parameter sort true if we sort the column
        Attribute: Parameter unique true if only those values that are unique are included in the copy
    */
    blueprint action Copy(boolean sort, boolean unique) returns DataFrameColumn

    /* 
        This action does a deep copy of the row between the 0-indexed rowStart and rowEnd. The two extra
        parameters indicate whether to sort the column or whether to require that it be unique.

        Attribute: Parameter rowStart the first row to copy
        Attribute: Parameter rowEnd the last row to copy
        Attribute: Parameter sort true if we sort the column
        Attribute: Parameter unique true if only those values that are unique are included in the copy
    */
    blueprint action Copy(integer rowStart, integer rowEnd, boolean sort, boolean unique) returns DataFrameColumn

    /* 
        This action does a deep copy of the row between the 0-indexed rowStart and rowEnd. 

        Attribute: Parameter rowStart the first row to copy
        Attribute: Parameter rowEnd the last row to copy
    */
    blueprint action Copy(integer rowStart, integer rowEnd) returns DataFrameColumn

    /*
        This action sets the size of the column to the parameter and then fills it with undefined values. 

        Attribute: Parameter size the size of the column.
    */
    blueprint action SetSize(integer size)

    /* 
        This action returns the number of rows. 
        Attribute: Returns The size of the column (number of rows).
    */
    action GetSize returns integer
        return 0
    end

    /*  This action returns the number of items in this column that are undefined.
        Attribute: Returns the number of items that are not defined
    */
    action GetUndefinedSize returns integer
        return undefinedSize
    end

    /*
        This is a convenience action that converts the entire column to a text format. This 
        allows it to be sent to the console or a text editor for viewing.

        Attribute: Returns a text representation of the entire column
    */
    blueprint action ToText returns text

    /*
        This action returns a default text string for undefined values.
    */
    action GetUndefinedText returns text
        return "undefined"
    end
end