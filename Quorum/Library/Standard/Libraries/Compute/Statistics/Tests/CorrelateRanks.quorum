package Libraries.Compute.Statistics.Tests

use Libraries.Compute.Statistics.Tests.StatisticalTest
use Libraries.Compute.Statistics.DataFrame
use Libraries.Compute.Statistics.Transforms.ConvertColumnsToRanksTransform
use Libraries.Containers.Array
use Libraries.Compute.Statistics.Reporting.CorrelateGroupsResult
use Libraries.Containers.Iterator
use Libraries.Compute.Math
use Libraries.Compute.Statistics.Distributions.HeavyTailNormalDistribution
use Libraries.Compute.Statistics.DataFrameColumn
use Libraries.Containers.HashTable
use Libraries.Compute.Statistics.Reporting.StatisticsFormatting

/*
    This class implements a Spearman Correlation Coefficient. For more information, see the 
    wikipedia page: https://en.wikipedia.org/wiki/Spearman%27s_rank_correlation_coefficient


    There are two ways to use this class. First, if we want to correlate two groups, 
    the class will automatically detect this case and we can call actions like 
    GetCorrelation, which will return that case. If we want to compare more than two groups, 
    these actions will throw errors and we will be requested to either iterate through 
    the results or two call the corresponding GetCorrelation(leftIndex, rightIndex) actions.

    Attribute: Author Andreas Stefik
    Attribute: Example

    use Libraries.Compute.Statistics.DataFrame
    use Libraries.Compute.Statistics.Tests.CorrelateGroups

    DataFrame frame
    frame:Load("Data/Data.csv")

    CorrelateRanks correlate
    correlate:Add(0)
    correlate:Add(1)
    frame:Calculate(correlate)
    
    output correlate:GetCorrelation()
*/
class CorrelateRanks is StatisticalTest
    /* The distribution used to calculate the p-value from the t and df values.*/
    HeavyTailNormalDistribution distribution

    /* A flag to let the user know approximation may be incorrect due to tied rankings. */
    boolean rankTiesWarning = false

    /* This stores a hash of all of the results. */
    HashTable<text, CorrelateGroupsResult> results        // Used to find the result by column or pair of columns.        
    HashTable<text, CorrelateGroupsResult> indexResults   // Used to find the result by index or pair of indices.

    Math math

    private action RunTest(DataFrame frame)
        if GetColumnSize() < 2
            alert("Must include at least two columns.")
        end

        CalculateCorrelation(frame)
    end

    /* This action calculates the CorrelateGroupsResult for each set of two selected column combinations in the frame. */
    private action CalculateCorrelation(DataFrame frame)
        ConvertColumnsToRanksTransform transform
        i = 0
        repeat while i < GetColumnSize()
            integer value = GetColumn(i)
            transform:AddColumn(value)
            i = i + 1
        end
        DataFrame newFrame = frame:Transform(transform)      

        i = 0
        repeat while i < GetColumnSize()
            j = i + 1
            repeat while j < GetColumnSize()
                DataFrameColumn left = newFrame:GetColumn(i)
                DataFrameColumn right = newFrame:GetColumn(j)

                CorrelateGroups groups
                groups:AddColumn(i)
                groups:AddColumn(j)
                newFrame:Calculate(groups)

                number n = left:GetSize()
                number df = n - 2
                number r = groups:GetCorrelation()
                number t = r / math:SquareRoot((1 - r * r) / (n - 2.0))
        
                distribution:Setup(df)
                number absoluteValueT = math:AbsoluteValue(t)
                number p = 2.0 * distribution:CumulativeDistribution(-absoluteValueT)

                text factor = ""
                text resultKey = left:GetHeader()+" & "+right:GetHeader()
                if GetFactorSize() > 0 and frame:GetColumn(GetFactor(0)):GetSize() > 0
                    factor = frame:GetColumn(GetFactor(0)):GetAsText(0)+" "+frame:GetColumn(GetFactor(0)):GetHeader()
                    resultKey = frame:GetColumn(GetFactor(0)):GetAsText(0) + " : " + resultKey
                end
                if not results:HasKey(resultKey)
                    CorrelateGroupsResult result
                    result:SetCorrelation(r)
                    result:SetProbabilityValue(p)
                    result:SetDegreesOfFreedom(df)
                    result:SetSpearman(true)
                    result:SetTestStatistic(t)
                    result:SetVariable1(left:GetHeader())
                    result:SetVariable2(right:GetHeader())
                    result:SetFormalTestName("Spearman's Rank Correlation")
                    result:SetFactor(factor)
                    result:AddColumn(GetColumn(i))
                    result:AddColumn(GetColumn(i))
                    results:Add(resultKey, result)
                    indexResults:Add(""+GetColumn(i)+" & "+GetColumn(j), result)
                end 

                j = j + 1
            end
            i = i + 1
        end
    end

    /*
        This returns an Iterator object of all results calculated. If there happened to only be 
        two correlations calculated, this iterator will still contain the one correlation.

        Attribute: Returns the results for the correlation. 

        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateGroups
        use Libraries.Containers.Iterator
    
        DataFrame frame
        frame:Load("Data/Data.csv")
    
        CorrelateRanks correlate
        correlate:Add(0)
        correlate:Add(1)
        frame:Calculate(correlate)
        
        Iterator<CorrelateGroupsResult> iterator = correlate:GetResultIterator()
    */
    action GetResultIterator returns Iterator<CorrelateGroupsResult>
        return results:GetValueIterator()
    end

    /*
        This returns the probability value if only one result exists.

        Attribute: Returns the probability value. 

        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
    
        CorrelateRanks correlate
        correlate:Add(0)
        correlate:Add(1)
        frame:Calculate(correlate)
        
        output correlate:GetProbabilityValue()
    */
    action GetProbabilityValue returns number
        return GetResult():GetProbabilityValue()
    end

    /*
        This returns the degrees of freedom if only one result exists.

        Attribute: Returns the Degrees of Freedom. 

        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
    
        CorrelateRanks correlate
        correlate:Add(0)
        correlate:Add(1)
        frame:Calculate(correlate)
        
        output correlate:GetDegreesOfFreedom()
    */
    action GetDegreesOfFreedom returns number
        return GetResult():GetDegreesOfFreedom()
    end

    /*
        This returns the t test statistic if only one result exists.

        Attribute: Returns the t test statistic. 

        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
    
        CorrelateRanks correlate
        correlate:Add(0)
        correlate:Add(1)
        frame:Calculate(correlate)
        
        output correlate:GetTestStatistic()
    */
    action GetTestStatistic returns number
        return GetResult():GetTestStatistic()
    end

    /*
        This returns the correlation value (r) if only one result exists.

        Attribute: Returns the correlation value. 

        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
    
        CorrelateRanks correlate
        correlate:Add(0)
        correlate:Add(1)
        frame:Calculate(correlate)
        
        output correlate:GetCorrelation()
    */
    action GetCorrelation returns number
        return GetResult():GetCorrelation()
    end

    /*
        This returns a result if only one exists. If there are more than one, 
        this action returns undefined.

        Attribute: Returns the CorrelateGroupsResult. 
        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
        frame:AddSelectedColumns("age")
        frame:AddSelectedColumns("bmi")
        CorrelateRanks compare = frame:CorrelateSelectedColumns()
        
        CorrelateGroupsResult result = compare:GetResult()
    */
    action GetResult returns CorrelateGroupsResult
        if results:GetSize() = 1
            return results:GetValueIterator():Next()
        else
            alert("There is more than one test result, either specify which result or use GetResults() for an array of all results")
        end
    end

    /*
        This returns a result between two particular columns. If no such result exists, 
        this action returns undefined.

        Attribute: Returns the CorrelateGroupsResult between two groups. 
        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
        frame:AddSelectedColumns("age")
        frame:AddSelectedColumns("bmi")
        CorrelateRanks compare = frame:CorrelateSelectedColumns()
        
        CorrelateGroupsResult result = compare:GetResult("age", "region")
    */
    action GetResult(text column1Name, text column2Name) returns CorrelateGroupsResult
        text hash1 = column1Name + " & " + column2Name
        text hash2 = column2Name + " & " + column1Name
        if results:HasKey(hash1)
            return results:GetValue(hash1)
        elseif results:HasKey(hash2)
            return results:GetValue(hash2)
        else
            alert("There are no test results with the columns " + hash1)
        end
    end

    /*
        This returns a result between two particular columns. If no such result exists, 
        this action returns undefined.

        Attribute: Returns the CorrelateGroupsResult between two groups. 
        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
        frame:AddSelectedColumns(0)
        frame:AddSelectedColumns(1)
        frame:AddSelectedColumns(2)
        CorrelateRanks compare = frame:CorrelateSelectedColumns()
        
        CorrelateGroupsResult result = compare:GetResult(0, 1)
    */
    action GetResult(integer column1Index, integer column2Index) returns CorrelateGroupsResult
        text hash1 = "" + column1Index + " & " + column2Index
        text hash2 = "" + column2Index + " & " + column1Index
        if indexResults:HasKey(hash1)
            return indexResults:GetValue(hash1)
        elseif indexResults:HasKey(hash2)
            return indexResults:GetValue(hash2)
        else
            alert("There are no test results with the column indices " + hash1)
        end
    end

    /*
        This returns the results between all computed columns.

        Attribute: Returns the CorrelateGroupsResults. 
        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
    
        CorrelateRanks compare
        compare:AddColumn(0)
        compare:AddColumn(1)
        compare:AddColumn(2)
        frame:Calculate(compare)
        
        Array<CorrelateGroupsResult> results = compare:GetResults()
    */
    action GetResults returns Array<CorrelateGroupsResult>
        return results:CopyToValueArray()
    end

    /*
        This action summarizes the results and lists them informally.

        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
    
        CorrelateRanks correlate
        correlate:Add(0)
        correlate:Add(1)
        frame:Calculate(correlate)
        
        output correlate:GetSummary()
    */
    action GetSummary returns text
        text summary = ""
        text lf = summary:GetLineFeed()
        Iterator<CorrelateGroupsResult> i = results:GetValueIterator()
        CorrelateGroupsResult result 
        repeat while i:HasNext()
            result = i:Next()

            summary = summary + lf
            summary = summary + result:GetSummary()
            summary = summary + lf
        end

        return summary
    end

    /*
        This action summarizes the results and places them into formal academic language, in 
        APA format.

        For more information: https://apastyle.apa.org/instructional-aids/numbers-statistics-guide.pdf

        Attribute: Example

        use Libraries.Compute.Statistics.DataFrame
        use Libraries.Compute.Statistics.Tests.CorrelateRanks
    
        DataFrame frame
        frame:Load("Data/Data.csv")
    
        CorrelateRanks correlate
        correlate:Add(0)
        correlate:Add(1)
        frame:Calculate(correlate)
        
        output correlate:GetFormalSummary()
    */
    action GetFormalSummary returns text
        StatisticsFormatting format = GetStatisticalFormatting()
        text summary = ""
        text lf = summary:GetLineFeed()
        Iterator<CorrelateGroupsResult> i = results:GetValueIterator()
        CorrelateGroupsResult result 
        repeat while i:HasNext()
            result = i:Next()
            result:SetFormat(format)

            summary = summary + lf
            summary = summary + result:GetFormalSummary()
            summary = summary + lf
        end

        return summary
    end
end